name: KICS Scan

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - '**/*.tf'

jobs:
  kics-scan:
    name: Run KICS Scanner
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-2

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials (optional for S3 upload)
        uses: aws-actions/configure-aws-credentials@v2
        if: ${{ env.ACCESS_KEY != '' && env.AWS_SECRET_ACCESS_KEY != '' }}
        with:
          aws-access-key-id: ${{ secrets.ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install KICS
        run: |
          curl -Lo kics https://github.com/Checkmarx/kics/releases/latest/download/kics-linux
          chmod +x kics
          sudo mv kics /usr/local/bin/

      - name: Run KICS on Terraform
        run: |
          mkdir -p kics-output
          kics scan -p . -o kics-output --output-name kics-results --report-formats json,html || true

      - name: Upload KICS Results as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: kics-results
          path: kics-output/

      - name: Upload KICS Results to S3 (optional)
        run: |
          if [[ -n "${{ secrets.ACCESS_KEY }}" && -n "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]]; then
            aws s3 cp kics-output/kics-results.json s3://your-kics-bucket/kics-results/kics-results.json
            aws s3 cp kics-output/kics-results.html s3://your-kics-bucket/kics-results/kics-results.html
          else
            echo "Skipping S3 upload â€” AWS credentials not set."
          fi
